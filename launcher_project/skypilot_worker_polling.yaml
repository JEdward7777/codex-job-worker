# SkyPilot task file for codex-job-worker (persistent polling mode)
#
# Processes jobs continuously, pulling code updates between each one.
# When no jobs are available, waits LOOP_INTERVAL seconds (default 300)
# before checking again.  The worker never exits on its own â€” it keeps
# the VM alive and polls indefinitely.
#
# For a cost-saving worker that exits when idle, see skypilot_worker.yaml.
#
# Usage:
#   # Set secrets as environment variables first
#   export GITLAB_TOKEN=your_gitlab_token
#   export WORKER_ID=your_worker_id
#
#   # Launch with SkyPilot (secrets passed via --env)
#   sky launch skypilot_worker_polling.yaml --env GITLAB_TOKEN --env WORKER_ID
#
#   # Or use an env file (not committed to repo)
#   sky launch skypilot_worker_polling.yaml --env-file .env.secrets
#
#   # Override the polling interval (e.g. 60 seconds):
#   sky launch skypilot_worker_polling.yaml --env GITLAB_TOKEN --env WORKER_ID --env LOOP_INTERVAL=60
#
# The .env.secrets file format:
#   GITLAB_TOKEN=your_gitlab_token
#   WORKER_ID=your_worker_id
#
# Supported clouds: aws, gcp, azure, lambda, runpod, kubernetes, vast
# See: https://vast.ai/article/vast-ai-gpus-can-now-be-rentend-through-skypilot

name: codex-job-worker-polling

resources:
  # Supported clouds: aws, gcp, azure, lambda, runpod, kubernetes, vast
  # Change this to your preferred cloud provider
  cloud: vast  # Vast.ai - often has the best GPU pricing
  #accelerators: "RTX3060:1"  # Adjust based on your needs
  #RTX3060:1 kept giving us a TI varient with only 8GB.
  #accelerators: "RTX4070:1"  #didn't match at all...
  accelerators: "RTX3090:1"
  # other more powerful options.
  # accelerators: A100:1
  # accelerators: V100:1


  # Optional: specify region for lower latency to GitLab server
  # region: us-east-1

# Number of nodes (1 for single worker)
num_nodes: 1

# Setup runs once when the cluster is provisioned
setup: |
  set -e

  # Install system dependencies
  sudo apt-get update
  sudo apt-get install -y git ffmpeg curl

  # Clone the worker repository
  REPO_URL="https://github.com/JEdward7777/codex-job-worker.git"
  INSTALL_DIR="$HOME/codex-job-worker"

  if [ ! -d "$INSTALL_DIR" ]; then
    git clone --recurse-submodules "$REPO_URL" "$INSTALL_DIR"
  else
    cd "$INSTALL_DIR"
    git pull origin main || true
    git submodule update --init --recursive
  fi

  # Run the shared setup script (installs uv, dependencies, applies patches)
  cd "$INSTALL_DIR"
  bash setup_worker.sh

# Run executes the actual task
run: |
  set -e
  export PATH="$HOME/.local/bin:$PATH"
  cd $HOME/codex-job-worker

  # Validate required environment variables
  if [ -z "$GITLAB_TOKEN" ]; then
    echo "ERROR: GITLAB_TOKEN environment variable is required"
    echo "Launch with: sky launch skypilot_worker_polling.yaml --env GITLAB_TOKEN=your_token --env WORKER_ID=your_id"
    exit 1
  fi

  if [ -z "$WORKER_ID" ]; then
    echo "ERROR: WORKER_ID environment variable is required"
    exit 1
  fi

  # Run the worker via the loop wrapper.
  # --loop-interval $LOOP_INTERVAL = wait that many seconds when idle, then re-check.
  # The bash wrapper handles git pull + restart between jobs.
  bash run_worker_loop.sh \
    --token "$GITLAB_TOKEN" \
    --worker-id "$WORKER_ID" \
    --loop-interval "$LOOP_INTERVAL" \
    --keep-jobs 5 \
    --verbose

# Environment variables (can be overridden at launch time)
envs:
  # These are placeholders - actual values should be passed via --env flag
  # GITLAB_TOKEN: ""  # Required - pass via --env GITLAB_TOKEN
  # WORKER_ID: ""     # Required - pass via --env WORKER_ID

  # Optional: GitLab server URL (defaults to https://git.genesisrnd.com)
  # GITLAB_URL: "https://git.genesisrnd.com"

  # Optional: Work directory for job files
  WORK_DIR: "/tmp/gpu_work"

  # Polling interval in seconds when no jobs are available (default: 300 = 5 minutes)
  LOOP_INTERVAL: "300"
