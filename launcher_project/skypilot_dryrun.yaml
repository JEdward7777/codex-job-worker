# SkyPilot DRY RUN task file for testing codex-job-worker setup
#
# This task:
# 1. Sets up the environment (clones repo, installs deps, applies patches)
# 2. Lists available jobs from GitLab to verify connectivity
# 3. Keeps the machine running so you can SSH in and explore
#
# Usage:
#   sky launch skypilot_dryrun.yaml --env-file .env.secrets
#
# After launch, SSH into the machine:
#   sky ssh codex-dryrun

name: codex-dryrun

resources:
  cloud: vast
  accelerators: RTX3060:1

num_nodes: 1

setup: |
  set -e
  echo "=========================================="
  echo "Setting up codex-job-worker (DRY RUN)"
  echo "=========================================="

  sudo apt-get update
  sudo apt-get install -y git ffmpeg

  REPO_URL="https://github.com/JEdward7777/codex-job-worker.git"
  INSTALL_DIR="$HOME/codex-job-worker"

  if [ ! -d "$INSTALL_DIR" ]; then
    echo "Cloning repository..."
    git clone --recurse-submodules "$REPO_URL" "$INSTALL_DIR"
  else
    echo "Repository exists, updating..."
    cd "$INSTALL_DIR"
    git pull origin main || true
    git submodule update --init --recursive
  fi

  if ! command -v uv &> /dev/null; then
    echo "Installing uv package manager..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
  fi
  export PATH="$HOME/.local/bin:$PATH"

  echo "Installing Python dependencies..."
  cd "$INSTALL_DIR"
  uv sync

  echo "Applying patches to submodules..."
  ./apply_submodule_patches.sh

  echo ""
  echo "=========================================="
  echo "Setup complete!"
  echo "=========================================="

run: |
  set -e
  export PATH="$HOME/.local/bin:$PATH"
  cd $HOME/codex-job-worker

  echo "=========================================="
  echo "DRY RUN TEST - Listing available jobs"
  echo "=========================================="
  echo ""

  if [ -z "$GITLAB_TOKEN" ]; then
    echo "ERROR: GITLAB_TOKEN environment variable is required"
    exit 1
  fi

  echo "Connecting to GitLab and listing available jobs..."
  echo ""

  uv run python gitlab_jobs.py list_available_jobs --verbose

  echo ""
  echo "=========================================="
  echo "DRY RUN COMPLETE - GitLab connectivity verified!"
  echo "=========================================="
  echo ""
  echo "Machine will stay running for exploration"
  echo "SSH in with: sky ssh codex-dryrun"
  echo ""
  echo "Sleeping indefinitely... (Ctrl+C to stop, or sky down codex-dryrun)"
  sleep infinity

envs:
  WORK_DIR: "/tmp/gpu_work"
